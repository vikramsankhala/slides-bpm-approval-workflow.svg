<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SVG Slide Player</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #111;
      color: #eee;
      font-family: system-ui, sans-serif;
      overflow: hidden;
    }
    
    /* Ensure controls are always visible */
    body {
      position: relative;
    }
    
    /* Allow scrolling when modal is open */
    body.modal-open {
      overflow: hidden;
    }

    .player {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      position: relative;
    }

    .stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #111;
      min-height: 0;
      overflow: hidden;
    }

    .stage object {
      width: 100%;
      height: 100%;
      border: none;
      background: #111;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: #222;
      border-top: 2px solid #444;
      position: relative;
      z-index: 100;
      min-height: 60px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
    }

    button {
      padding: 0.5rem 1.2rem;
      border-radius: 6px;
      border: 2px solid #555;
      background: #333;
      color: #fff;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      min-width: 80px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    button:hover:not(:disabled) {
      background: #444;
      border-color: #666;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: #222;
      border-color: #333;
    }
    button.primary {
      background: #0066cc;
      border-color: #0055aa;
      color: #fff;
      font-weight: 600;
    }
    button.primary:hover:not(:disabled) {
      background: #0077dd;
      border-color: #0066cc;
    }
    
    #audioToggleBtn {
      background: #444;
      border-color: #666;
      min-width: 50px;
    }
    
    #audioToggleBtn:hover:not(:disabled) {
      background: #555;
    }

    /* AI Generator Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    /* Custom scrollbar styling - Always visible */
    .modal::-webkit-scrollbar,
    .modal-content::-webkit-scrollbar,
    .preview-area::-webkit-scrollbar {
      width: 16px;
      -webkit-appearance: none;
    }
    
    .modal::-webkit-scrollbar-track,
    .modal-content::-webkit-scrollbar-track,
    .preview-area::-webkit-scrollbar-track {
      background: #1a1a1a;
      border-radius: 8px;
      border: 1px solid #333;
    }
    
    .modal::-webkit-scrollbar-thumb,
    .modal-content::-webkit-scrollbar-thumb,
    .preview-area::-webkit-scrollbar-thumb {
      background: #666;
      border-radius: 8px;
      border: 2px solid #1a1a1a;
      min-height: 30px;
    }
    
    .modal::-webkit-scrollbar-thumb:hover,
    .modal-content::-webkit-scrollbar-thumb:hover,
    .preview-area::-webkit-scrollbar-thumb:hover {
      background: #888;
    }
    
    .modal::-webkit-scrollbar-thumb:active,
    .modal-content::-webkit-scrollbar-thumb:active,
    .preview-area::-webkit-scrollbar-thumb:active {
      background: #aaa;
    }
    
    /* Firefox scrollbar - Always visible */
    .modal,
    .modal-content,
    .preview-area {
      scrollbar-width: auto;
      scrollbar-color: #666 #1a1a1a;
    }
    
    /* Force scrollbar to always show when content overflows */
    .modal-content {
      overflow-y: scroll !important;
    }
    
    .preview-area {
      overflow-y: scroll !important;
    }

    .modal-content {
      background-color: #222;
      margin: 2% auto;
      margin-bottom: 5%;
      padding: 2rem;
      border: 1px solid #444;
      border-radius: 8px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      color: #eee;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: #555 #1a1a1a;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #444;
      padding-bottom: 1rem;
    }

    .modal-header h2 {
      margin: 0;
      color: #eee;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close:hover {
      color: #fff;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #ccc;
      font-weight: 500;
    }

    .form-group select,
    .form-group textarea,
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #555;
      border-radius: 4px;
      background: #333;
      color: #eee;
      font-family: inherit;
      font-size: 0.9rem;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-group input[type="text"] {
      margin-bottom: 0.5rem;
    }

    .template-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .template-btn {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      background: #444;
      border: 1px solid #666;
    }

    .template-btn:hover {
      background: #555;
    }

    .template-btn.active {
      background: #0066cc;
      border-color: #0055aa;
    }

    .api-key-note {
      background: #333;
      padding: 1rem;
      border-radius: 4px;
      border-left: 3px solid #0066cc;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      color: #ccc;
    }

    .api-key-note code {
      background: #222;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      color: #fff;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 2rem;
      color: #ccc;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid #333;
      border-top: 3px solid #0066cc;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #442222;
      color: #ffaaaa;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      display: none;
    }

    .error.active {
      display: block;
    }

    .success {
      background: #224422;
      color: #aaffaa;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      display: none;
    }

    .success.active {
      display: block;
    }

    .preview-area {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #1a1a1a;
      border-radius: 4px;
      border: 1px solid #444;
      max-height: 400px;
      overflow-y: scroll;
      overflow-x: hidden;
    }

    .preview-area svg {
      max-width: 100%;
      height: auto;
    }

    .button-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* Simple fade+scale animation for elements in the SVG */
    .svg-animate-in {
      opacity: 0;
      transform-box: fill-box;
      transform-origin: center;
      animation: fadeInScale 0.6s ease-out forwards;
    }

    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.8); }
      to   { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="player">
    <div class="stage">
      <object id="slideFrame" type="image/svg+xml"></object>
    </div>
    <div class="controls">
      <button id="prevBtn">Prev (‚Üê)</button>
      <button id="playBtn">Play</button>
      <button id="pauseBtn" disabled>Pause</button>
      <button id="nextBtn">Next (‚Üí)</button>
      <button id="aiGeneratorBtn" class="primary">ü§ñ AI Generator</button>
      <button id="audioToggleBtn" title="Toggle audio narration">üîä</button>
      <span id="status" style="margin-left:1.5rem;font-size:0.95rem;opacity:0.9;color:#fff;font-weight:500;"></span>
    </div>
  </div>
  
  <!-- Hidden audio element with autoplay -->
  <audio id="narrationAudio" preload="auto" autoplay></audio>

  <!-- AI Generator Modal -->
  <div id="aiModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>AI Content Generator</h2>
        <button class="close" id="closeModal">&times;</button>
      </div>

      <div class="api-key-note">
        <strong>Note:</strong> A default API key is configured. You can override it below if needed.
        Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #0066cc;">OpenAI Platform</a>
      </div>

      <div class="form-group">
        <label for="apiKey">OpenAI API Key (optional - pre-configured):</label>
        <input type="password" id="apiKey" placeholder="sk-..." />
        <small style="color: #888; font-size: 0.85rem;">Default key is pre-loaded. Change only if you want to use a different key.</small>
      </div>

      <div class="form-group">
        <label for="slideType">Slide Type:</label>
        <select id="slideType">
          <option value="custom">Custom Prompt</option>
          <option value="title">Title Slide</option>
          <option value="bpm">BPM Diagram</option>
          <option value="infographic">Infographic</option>
          <option value="chart">Chart/Graph</option>
          <option value="timeline">Timeline</option>
          <option value="process">Process Flow</option>
        </select>
      </div>

      <div class="form-group">
        <label>Quick Templates:</label>
        <div class="template-buttons">
          <button class="template-btn" data-template="title">Title Slide</button>
          <button class="template-btn" data-template="bpm">BPM Diagram</button>
          <button class="template-btn" data-template="infographic">Infographic</button>
          <button class="template-btn" data-template="chart">Bar Chart</button>
          <button class="template-btn" data-template="timeline">Timeline</button>
        </div>
      </div>

      <div class="form-group">
        <label for="prompt">Prompt / Description:</label>
        <textarea id="prompt" placeholder="Describe what you want on your slide..."></textarea>
      </div>

      <div class="form-group">
        <label for="fileName">File Name (without .svg):</label>
        <input type="text" id="fileName" placeholder="my-slide" />
      </div>

      <div class="error" id="errorMsg"></div>
      <div class="success" id="successMsg"></div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Generating slide with AI...</p>
      </div>

      <div class="button-group">
        <button id="generateBtn" class="primary">Generate Slide</button>
        <button id="previewBtn">Preview</button>
        <button id="downloadBtn" disabled>Download SVG</button>
      </div>

      <div class="preview-area" id="previewArea" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Define your slide list
    const slides = [
      'slides/demo-01-welcome.svg',
      'slides/demo-02-what-is.svg',
      'slides/demo-03-svg-format.svg',
      'slides/demo-04-controls.svg',
      'slides/demo-05-ai-generator-intro.svg',
      'slides/demo-06-ai-step1.svg',
      'slides/demo-07-ai-step2.svg',
      'slides/demo-08-ai-step3.svg',
      'slides/demo-09-ai-step4.svg',
      'slides/demo-10-animations.svg'
    ];
    
    // Narration text for each slide
    const slideNarrations = [
      "Welcome to the SVG Slide Player. This is a professional presentation tool designed specifically for SVG image files. Think of it like PowerPoint, but simpler and more elegant.",
      "The Slide Player is a simple web application that displays a series of SVG images one at a time, like a digital slideshow. You can navigate through slides manually or set them to play automatically.",
      "SVG stands for Scalable Vector Graphics. It's a type of image format, like JPG or PNG, but designed for vector graphics. Unlike raster images, SVG files scale perfectly at any size and can be edited as code. You can create SVGs using tools like Inkscape, Adobe Illustrator, or Figma.",
      "At the bottom of the screen, you'll see control buttons. Prev moves to the previous slide, Play starts automatic playback, Pause stops it, and Next moves to the next slide. You can also use keyboard shortcuts: Right Arrow or Spacebar for next, Left Arrow for previous. The status display shows which slide you're viewing.",
      "The AI Content Generator lets you create professional slides instantly. Click the AI Generator button to access templates for BPM diagrams, infographics, charts, timelines, and more. Generate slides using AI prompts and download them instantly.",
      "Step 1: Open the AI Generator. Click the blue AI Generator button at the bottom of the screen. A modal window will open with generation options, allowing you to select templates or enter custom prompts.",
      "Step 2: Choose a template or enter a custom prompt. Quick templates are available for Title Slides, BPM Diagrams, Infographics, Bar Charts, and Timelines. Click a template button for quick start, or type your own description for custom slides.",
      "Step 3: Generate and preview your slide. Click the Generate Slide button, and the AI will create your SVG code. A preview appears below showing your generated slide. Review it before downloading.",
      "Step 4: Download and use your slide. Enter a file name, then click Download SVG. The file will be saved to your downloads folder. Move it to your slides folder and add it to the slides array in index.html to include it in your presentation.",
      "Adding animations to your slides is optional but powerful. Elements fade in from invisible to visible and scale up from 80% to 100% size over 0.6 seconds. To animate an element, open your SVG file in a text editor and add data-animate equals true to that element."
    ];

    let current = 0;
    let autoPlayTimer = null;
    const autoPlayDelay = 6000; // Fallback delay if audio duration unavailable
    let generatedSVG = null;
    let audioEnabled = true;
    let currentAudio = null;
    let userInteracted = false;
    let audioDurations = {}; // Cache for audio durations
    let nextSlideTimeout = null;

    const frame = document.getElementById('slideFrame');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const audioToggleBtn = document.getElementById('audioToggleBtn');
    const statusEl = document.getElementById('status');
    const narrationAudio = document.getElementById('narrationAudio');
    const aiGeneratorBtn = document.getElementById('aiGeneratorBtn');
    const aiModal = document.getElementById('aiModal');
    const closeModal = document.getElementById('closeModal');
    const generateBtn = document.getElementById('generateBtn');
    const previewBtn = document.getElementById('previewBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const slideType = document.getElementById('slideType');
    const promptInput = document.getElementById('prompt');
    const fileNameInput = document.getElementById('fileName');
    const apiKeyInput = document.getElementById('apiKey');
    const loading = document.getElementById('loading');
    const errorMsg = document.getElementById('errorMsg');
    const successMsg = document.getElementById('successMsg');
    const previewArea = document.getElementById('previewArea');

    // Template prompts
    const templates = {
      title: {
        prompt: 'Create a professional title slide with:\n- Main title: "Welcome"\n- Subtitle: "Introduction"\n- Dark background (#1a1a1a)\n- White text, centered\n- Modern, clean design\n- 800x600 dimensions',
        fileName: 'title-slide'
      },
      bpm: {
        prompt: 'Create a BPMN diagram showing a business process:\n- Title: "Process Flow"\n- Start event (circle) ‚Üí Task 1 ‚Üí Decision (diamond) ‚Üí Task 2 ‚Üí End event\n- Use standard BPMN shapes and colors\n- Dark background (#111)\n- Blue for tasks, yellow for decisions\n- 800x600 dimensions\n- Include data-animate="true" on each element',
        fileName: 'bpm-diagram'
      },
      infographic: {
        prompt: 'Create an infographic slide with:\n- Title: "Key Statistics" at top\n- Three large numbers with icons:\n  1. "500" with icon (left)\n  2. "$10M" with icon (center)\n  3. "50" with icon (right)\n- Dark background (#1a1a1a)\n- Colorful but professional\n- 800x600 dimensions\n- Add data-animate="true" to each section',
        fileName: 'infographic'
      },
      chart: {
        prompt: 'Create a bar chart slide:\n- Title: "Sales Results Q1 2024"\n- Four bars showing values: 100, 150, 120, 180\n- Labels: Jan, Feb, Mar, Apr\n- Green bars on dark background\n- White text\n- 800x600 dimensions',
        fileName: 'bar-chart'
      },
      timeline: {
        prompt: 'Create a timeline slide:\n- Title: "Project Timeline"\n- Horizontal timeline with 4 milestones\n- Dates and descriptions for each milestone\n- Dark background\n- Modern design\n- 800x600 dimensions\n- Add data-animate="true" to milestones',
        fileName: 'timeline'
      }
    };

    // Template button handlers
    document.querySelectorAll('.template-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const template = templates[btn.dataset.template];
        if (template) {
          promptInput.value = template.prompt;
          fileNameInput.value = template.fileName;
          slideType.value = btn.dataset.template === 'title' ? 'title' : 
                           btn.dataset.template === 'bpm' ? 'bpm' :
                           btn.dataset.template === 'infographic' ? 'infographic' :
                           btn.dataset.template === 'chart' ? 'chart' :
                           btn.dataset.template === 'timeline' ? 'timeline' : 'custom';
        }
      });
    });

    // Default API key - loaded from environment variable or Netlify build-time injection
    // For Netlify: Set OPENAI_API_KEY in site environment variables (will be injected by build script)
    // For local: Set in browser localStorage with key 'openai_api_key'
    // Build script will replace this placeholder with actual key during Netlify build
    const DEFAULT_API_KEY = window.OPENAI_API_KEY || 'NETLIFY_API_KEY_PLACEHOLDER';

    // Modal controls
    aiGeneratorBtn.onclick = () => {
      aiModal.style.display = 'block';
      document.body.classList.add('modal-open');
      // Load API key from localStorage if available, otherwise use default
      const savedKey = localStorage.getItem('openai_api_key') || DEFAULT_API_KEY;
      apiKeyInput.value = savedKey;
      // Scroll to top of modal
      aiModal.scrollTop = 0;
    };

    closeModal.onclick = () => {
      aiModal.style.display = 'none';
      document.body.classList.remove('modal-open');
      resetModal();
    };

    window.onclick = (event) => {
      if (event.target === aiModal) {
        aiModal.style.display = 'none';
        document.body.classList.remove('modal-open');
        resetModal();
      }
    };

    function resetModal() {
      errorMsg.classList.remove('active');
      successMsg.classList.remove('active');
      loading.classList.remove('active');
      previewArea.style.display = 'none';
      generatedSVG = null;
      downloadBtn.disabled = true;
    }

    // Generate slide using AI or template
    generateBtn.onclick = async () => {
      const prompt = promptInput.value.trim();
      const fileName = fileNameInput.value.trim() || 'generated-slide';
      const type = slideType.value;
      // Use input value, localStorage, or default API key (in that order)
      const apiKey = apiKeyInput.value.trim() || localStorage.getItem('openai_api_key') || DEFAULT_API_KEY;

      if (!prompt) {
        showError('Please enter a prompt or select a template');
        return;
      }

      // Save API key to localStorage if provided
      if (apiKeyInput.value.trim()) {
        localStorage.setItem('openai_api_key', apiKeyInput.value.trim());
      }

      loading.classList.add('active');
      errorMsg.classList.remove('active');
      successMsg.classList.remove('active');
      generateBtn.disabled = true;

      try {
        let svgCode;

        if (apiKey && apiKey.startsWith('sk-')) {
          // Use OpenAI API
          svgCode = await generateWithOpenAI(prompt, type, apiKey);
        } else {
          // Use template-based generation
          svgCode = generateFromTemplate(prompt, type);
        }

        generatedSVG = svgCode;
        previewArea.innerHTML = svgCode;
        previewArea.style.display = 'block';
        downloadBtn.disabled = false;
        showSuccess('Slide generated successfully! Preview below, then download to save.');
      } catch (error) {
        showError('Error generating slide: ' + error.message);
        console.error('Generation error:', error);
      } finally {
        loading.classList.remove('active');
        generateBtn.disabled = false;
      }
    };

    // Generate using OpenAI API
    async function generateWithOpenAI(prompt, type, apiKey) {
      const systemPrompt = `You are an expert SVG designer. Generate complete, valid SVG code for presentation slides.
Requirements:
- Always include viewBox="0 0 800 600"
- Include xmlns="http://www.w3.org/2000/svg"
- Use dark background (#111 or #1a1a1a)
- White or light colored text
- Professional, modern design
- Add data-animate="true" to elements that should animate
- Provide complete, self-contained SVG code
- No external references or images

${type === 'bpm' ? 'Use standard BPMN notation with rectangles for tasks, diamonds for decisions, circles for events.' : ''}
${type === 'infographic' ? 'Create an engaging infographic with large numbers, icons made from SVG shapes, and clear visual hierarchy.' : ''}
${type === 'chart' ? 'Create clean, professional charts using SVG rectangles, lines, and text.' : ''}`;

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: prompt }
          ],
          temperature: 0.7,
          max_tokens: 2000
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error?.message || 'OpenAI API error');
      }

      const data = await response.json();
      let svgCode = data.choices[0].message.content.trim();

      // Extract SVG code if wrapped in markdown code blocks
      const svgMatch = svgCode.match(/```(?:svg|html)?\s*([\s\S]*?)```/);
      if (svgMatch) {
        svgCode = svgMatch[1].trim();
      }

      // Ensure it starts with <svg
      if (!svgCode.startsWith('<svg')) {
        throw new Error('Generated content is not valid SVG code');
      }

      return svgCode;
    }

    // Generate from template (fallback when no API key)
    function generateFromTemplate(prompt, type) {
      const baseSVG = `<svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
  <rect width="800" height="600" fill="#1a1a1a"/>
`;

      let content = '';

      if (type === 'title') {
        content = `  <text x="400" y="250" fill="#fff" font-size="56" text-anchor="middle" font-weight="bold" data-animate="true">
    Welcome
  </text>
  <text x="400" y="320" fill="#ccc" font-size="32" text-anchor="middle" data-animate="true">
    Introduction
  </text>`;
      } else if (type === 'bpm') {
        content = `  <text x="400" y="50" fill="#fff" font-size="36" text-anchor="middle" font-weight="bold">Process Flow</text>
  <circle cx="150" cy="200" r="20" fill="none" stroke="#4CAF50" stroke-width="2" data-animate="true"/>
  <text x="150" y="205" fill="#4CAF50" font-size="14" text-anchor="middle">Start</text>
  <rect x="250" y="180" width="100" height="40" fill="#2196F3" rx="5" data-animate="true"/>
  <text x="300" y="205" fill="#fff" font-size="16" text-anchor="middle">Task 1</text>
  <polygon points="450,200 500,180 550,200 500,220" fill="#FFC107" data-animate="true"/>
  <text x="500" y="205" fill="#000" font-size="14" text-anchor="middle">Decision</text>
  <rect x="600" y="180" width="100" height="40" fill="#2196F3" rx="5" data-animate="true"/>
  <text x="650" y="205" fill="#fff" font-size="16" text-anchor="middle">Task 2</text>
  <circle cx="750" cy="200" r="20" fill="none" stroke="#f44336" stroke-width="3" data-animate="true"/>
  <text x="750" y="205" fill="#f44336" font-size="14" text-anchor="middle">End</text>
  <line x1="170" y1="200" x2="240" stroke="#fff" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="350" y1="200" x2="440" stroke="#fff" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="520" y1="200" x2="590" stroke="#fff" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="700" y1="200" x2="730" stroke="#fff" stroke-width="2" marker-end="url(#arrowhead)"/>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#fff"/>
    </marker>
  </defs>`;
      } else if (type === 'infographic') {
        content = `  <text x="400" y="80" fill="#fff" font-size="42" text-anchor="middle" font-weight="bold">Key Statistics</text>
  <g data-animate="true">
    <circle cx="200" cy="300" r="60" fill="#4CAF50" opacity="0.3"/>
    <text x="200" y="295" fill="#4CAF50" font-size="64" text-anchor="middle" font-weight="bold">500</text>
    <text x="200" y="340" fill="#ccc" font-size="20" text-anchor="middle">Employees</text>
  </g>
  <g data-animate="true">
    <circle cx="400" cy="300" r="60" fill="#2196F3" opacity="0.3"/>
    <text x="400" y="295" fill="#2196F3" font-size="64" text-anchor="middle" font-weight="bold">$10M</text>
    <text x="400" y="340" fill="#ccc" font-size="20" text-anchor="middle">Revenue</text>
  </g>
  <g data-animate="true">
    <circle cx="600" cy="300" r="60" fill="#FF9800" opacity="0.3"/>
    <text x="600" y="295" fill="#FF9800" font-size="64" text-anchor="middle" font-weight="bold">50</text>
    <text x="600" y="340" fill="#ccc" font-size="20" text-anchor="middle">Countries</text>
  </g>`;
      } else {
        // Generic template
        content = `  <text x="400" y="300" fill="#fff" font-size="48" text-anchor="middle" data-animate="true">
    ${prompt.substring(0, 50) || 'Your Content Here'}
  </text>`;
      }

      return baseSVG + content + '\n</svg>';
    }

    // Preview generated slide
    previewBtn.onclick = () => {
      if (generatedSVG) {
        previewArea.innerHTML = generatedSVG;
        previewArea.style.display = 'block';
      } else {
        showError('Please generate a slide first');
      }
    };

    // Download generated slide
    downloadBtn.onclick = () => {
      if (!generatedSVG) {
        showError('No slide generated yet');
        return;
      }

      const fileName = fileNameInput.value.trim() || 'generated-slide';
      const blob = new Blob([generatedSVG], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName + '.svg';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showSuccess(`Slide downloaded as ${fileName}.svg - Don't forget to add it to your slides folder and update the slides array in index.html!`);
    };

    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.classList.add('active');
      successMsg.classList.remove('active');
    }

    function showSuccess(message) {
      successMsg.textContent = message;
      successMsg.classList.add('active');
      errorMsg.classList.remove('active');
    }

    // Slide player functions
    async function loadSlide(index) {
      if (index < 0 || index >= slides.length) return;
      
      // Stop current audio if playing
      stopNarration();
      
      // Clear any pending next slide timeout
      if (nextSlideTimeout) {
        clearTimeout(nextSlideTimeout);
        nextSlideTimeout = null;
      }
      
      current = index;
      frame.data = slides[current];
      statusEl.textContent = `Slide ${current + 1} / ${slides.length}`;
      
      // Play narration for this slide if audio is enabled
      if (audioEnabled && slideNarrations[current]) {
        const audioDuration = await playNarration(current);
        
        // If auto-play is active, schedule next slide based on audio duration
        if (autoPlayTimer && audioDuration > 0) {
          // Clear existing timer
          clearInterval(autoPlayTimer);
          autoPlayTimer = null;
          
          // Schedule next slide after audio completes
          nextSlideTimeout = setTimeout(() => {
            if (autoPlayTimer === null) {
              // Auto-play is still active, advance to next slide
              nextSlide(true);
            }
          }, audioDuration + 500); // Add 500ms buffer after audio ends
        }
      }
    }
    
    // Audio narration functions - using static files with Web Speech API fallback
    function playNarration(slideIndex) {
      if (!audioEnabled || !slideNarrations[slideIndex]) {
        // If audio disabled, return duration 0 so slide advances immediately
        return Promise.resolve(0);
      }
      
      return new Promise((resolve) => {
        const audioPath = `audio/narration-${slideIndex + 1}.mp3`;
        
        // Stop any currently playing audio
        stopNarration();
        
        // Create new audio element for each slide to ensure autoplay works
        const audio = new Audio(audioPath);
        audio.volume = 0.8;
        audio.preload = 'auto';
        currentAudio = audio;
        
        let duration = autoPlayDelay; // Default fallback duration
        
        audio.onerror = () => {
          // If audio file doesn't exist, use Web Speech API as fallback
          console.log(`Audio file not found, using Web Speech API for slide ${slideIndex + 1}`);
          const speechDuration = estimateSpeechDuration(slideNarrations[slideIndex]);
          speakText(slideNarrations[slideIndex]);
          resolve(speechDuration);
        };
        
        audio.onloadedmetadata = () => {
          // Get the actual duration of the audio file
          duration = (audio.duration * 1000) || autoPlayDelay; // Convert to milliseconds
          audioDurations[slideIndex] = duration;
          console.log(`Audio duration for slide ${slideIndex + 1}: ${duration}ms`);
        };
        
        audio.onended = () => {
          // Audio finished playing
          console.log(`Audio finished for slide ${slideIndex + 1}`);
          resolve(duration);
        };
        
        // Try to play immediately
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              // Audio started playing successfully
              console.log(`Playing narration for slide ${slideIndex + 1}`);
              // Use cached duration if available, otherwise wait for metadata
              if (audioDurations[slideIndex]) {
                duration = audioDurations[slideIndex];
              }
            })
            .catch(error => {
              // Auto-play was prevented
              console.log('Auto-play prevented, using Web Speech API fallback');
              // Use Web Speech API as fallback (doesn't require user interaction)
              const speechDuration = estimateSpeechDuration(slideNarrations[slideIndex]);
              speakText(slideNarrations[slideIndex]);
              resolve(speechDuration);
            });
        }
        
        // Load the audio
        audio.load();
        
        // Fallback: if duration not determined within 2 seconds, use default
        setTimeout(() => {
          if (!audioDurations[slideIndex]) {
            resolve(duration);
          }
        }, 2000);
      });
    }
    
    // Estimate speech duration (average speaking rate: ~150 words per minute)
    function estimateSpeechDuration(text) {
      const words = text.split(' ').length;
      const wordsPerMinute = 150;
      const durationMs = (words / wordsPerMinute) * 60 * 1000;
      return Math.max(durationMs, 3000); // Minimum 3 seconds
    }
    
    // Fallback: Use Web Speech API (browser's built-in TTS)
    function speakText(text) {
      if ('speechSynthesis' in window) {
        // Stop any ongoing speech
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9; // Slightly slower for clarity
        utterance.pitch = 1.0;
        utterance.volume = 0.8;
        
        // Try to use a better voice if available
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => 
          v.name.includes('Google') || 
          v.name.includes('Microsoft') ||
          v.lang.startsWith('en')
        );
        if (preferredVoice) {
          utterance.voice = preferredVoice;
        }
        
        window.speechSynthesis.speak(utterance);
      }
    }
    
    // Load voices when available
    if ('speechSynthesis' in window) {
      window.speechSynthesis.onvoiceschanged = () => {
        // Voices loaded
      };
    }
    
    // Track user interaction to enable autoplay
    document.addEventListener('click', () => {
      userInteracted = true;
    }, { once: true });
    
    document.addEventListener('keydown', () => {
      userInteracted = true;
    }, { once: true });
    
    function stopNarration() {
      // Stop current audio element
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
      }
      // Also stop the main audio element
      if (narrationAudio) {
        narrationAudio.pause();
        narrationAudio.currentTime = 0;
      }
      // Also stop Web Speech API if active
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
    }
    
    function toggleAudio() {
      audioEnabled = !audioEnabled;
      audioToggleBtn.textContent = audioEnabled ? 'üîä' : 'üîá';
      audioToggleBtn.title = audioEnabled ? 'Mute audio' : 'Unmute audio';
      
      if (!audioEnabled) {
        stopNarration();
      } else if (slideNarrations[current]) {
        playNarration(current);
      }
    }
    
    audioToggleBtn.onclick = toggleAudio;

    function onSlideLoaded() {
      const svgDoc = frame.contentDocument;
      if (!svgDoc) return;

      const animElems = svgDoc.querySelectorAll('[data-animate="true"]');
      animElems.forEach(el => {
        el.classList.remove('svg-animate-in');
        void el.getBBox();
        el.classList.add('svg-animate-in');
      });
    }

    frame.addEventListener('load', onSlideLoaded);

    function nextSlide(loop = true) {
      let next = current + 1;
      if (next >= slides.length) next = loop ? 0 : slides.length - 1;
      loadSlide(next);
    }

    function prevSlide() {
      let prev = current - 1;
      if (prev < 0) prev = slides.length - 1;
      loadSlide(prev);
    }

    prevBtn.onclick = () => {
      stopAutoPlay();
      prevSlide();
    };

    nextBtn.onclick = () => {
      stopAutoPlay();
      nextSlide(false);
    };

    function startAutoPlay() {
      if (autoPlayTimer) return;
      playBtn.disabled = true;
      pauseBtn.disabled = false;
      statusEl.textContent = `Auto-play (audio-based) ‚Äî Slide ${current + 1} / ${slides.length}`;
      
      // Mark auto-play as active (we'll use audio-based timing instead of interval)
      autoPlayTimer = true; // Use true instead of interval ID
      
      // Start playing narration for current slide, which will trigger next slide when done
      if (audioEnabled && slideNarrations[current]) {
        playNarration(current).then(duration => {
          if (autoPlayTimer && duration > 0) {
            nextSlideTimeout = setTimeout(() => {
              if (autoPlayTimer) {
                nextSlide(true);
              }
            }, duration + 500);
          }
        });
      } else {
        // Fallback to interval if no audio
        autoPlayTimer = setInterval(() => nextSlide(true), autoPlayDelay);
      }
    }

    function stopAutoPlay() {
      if (!autoPlayTimer) return;
      
      // Clear interval if it exists
      if (typeof autoPlayTimer === 'number') {
        clearInterval(autoPlayTimer);
      }
      
      // Clear next slide timeout
      if (nextSlideTimeout) {
        clearTimeout(nextSlideTimeout);
        nextSlideTimeout = null;
      }
      
      autoPlayTimer = null;
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      statusEl.textContent = `Manual mode ‚Äî Slide ${current + 1} / ${slides.length}`;
    }

    playBtn.onclick = startAutoPlay;
    pauseBtn.onclick = stopAutoPlay;

    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowRight' || e.key === ' ') {
        e.preventDefault();
        stopAutoPlay();
        nextSlide(false);
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        stopAutoPlay();
        prevSlide();
      }
    });

    loadSlide(current);
  </script>
</body>
</html>
